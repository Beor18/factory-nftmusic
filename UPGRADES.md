# üîÑ Contratos Upgradeables - Gu√≠a Completa

Esta gu√≠a explica c√≥mo usar la arquitectura upgradeable completa implementada en el proyecto de NFTs musicales de Tuneport.

## üìã Resumen

Se ha implementado un patr√≥n de proxy upgradeable usando **OpenZeppelin Upgrades** con el est√°ndar **UUPS** (Universal Upgradeable Proxy Standard) que permite:

- ‚úÖ Actualizar la l√≥gica de los contratos sin perder datos
- ‚úÖ Mantener las mismas direcciones de contrato
- ‚úÖ Corregir bugs y agregar nuevas funcionalidades
- ‚úÖ Mejor eficiencia en gas comparado con otros patrones
- ‚úÖ **Portabilidad total** - Los artistas pueden usar sus contratos en cualquier plataforma

## üèóÔ∏è Arquitectura Completa

### Contratos Upgradeables Desplegados:

#### **1. Factories (Usados por el Frontend)**

**`MusicNFTFactoryUpgradeable.sol`**

- Factory upgradeable que crea colecciones upgradeables usando proxies
- **Proxy Address**: `0xAD6474aB644B97A4B82C2128921c32aF69392B15` (Base Sepolia)
- **Implementation**: `0xC8577Fd1d613e372FB0682eFf33b5Cfa20afeAf6`

**`RevenueShareFactoryUpgradeable.sol`**

- Factory upgradeable para crear contratos de distribuci√≥n de ingresos upgradeables
- **Proxy Address**: `0x60CD9B009799636f59367E4C06b5Ad95Ce1E218F` (Base Sepolia)
- **Implementation**: `0x3cBA4cc0212450144A5C13778B11d8F210d634E2`

#### **2. Implementation Templates**

**`MusicCollectionUpgradeable.sol`**

- Versi√≥n upgradeable del contrato de colecci√≥n ERC1155
- **Implementation Address**: `0xF8BE24aA04Bb95C5038F8dc1dAE28c0BD191cC36`
- Usado como template para todas las colecciones creadas por el factory

**`RevenueShareUpgradeable.sol`**

- Versi√≥n upgradeable del contrato de distribuci√≥n de ingresos para NFT musicales
- **Implementation Address**: `0x4151C8c01Eec4426179231AAfB37dCa81Ed19C14`
- Usado como template para todos los revenue shares creados por el factory

### Patrones Implementados:

- **UUPS Proxy Pattern** - Para upgrades eficientes y gas-optimizados
- **Factory + Proxy Pattern** - Para crear m√∫ltiples instancias upgradeables
- **Initializer Pattern** - En lugar de constructores para compatibilidad con proxies

## üöÄ Instalaci√≥n y Setup

### 1. Instalar Dependencias

```bash
npm install
```

Las dependencias incluyen:

- `@openzeppelin/contracts-upgradeable` - Contratos upgradeables
- `@openzeppelin/hardhat-upgrades` - Plugin de Hardhat para upgrades
- `hardhat` - Framework de desarrollo

### 2. Compilar Contratos

```bash
npm run compile
```

## üì¶ Deployment

### Deployment Inicial Completo

Para desplegar todos los contratos upgradeables:

```bash
# Red local
npx hardhat run scripts/deploy-all-upgradeable.js

# Testnet (Base Sepolia) - Ya desplegado
npx hardhat run scripts/deploy-all-upgradeable.js --network baseSepolia
```

Esto crea **autom√°ticamente**:

1. **MusicCollectionUpgradeable Implementation**
2. **MusicNFTFactoryUpgradeable Proxy + Implementation**
3. **RevenueShareUpgradeable Implementation**
4. **RevenueShareFactoryUpgradeable Proxy + Implementation**
5. **Archivos de configuraci√≥n**: `deployment-upgradeable-complete.json` y `frontend-config.json`

### Resultado del Deployment (Base Sepolia)

```
üéµ MUSIC NFT CONTRACTS:
  üè≠ Factory Proxy: 0xAD6474aB644B97A4B82C2128921c32aF69392B15
  üîß Factory Implementation: 0xC8577Fd1d613e372FB0682eFf33b5Cfa20afeAf6
  üìú Collection Implementation: 0xF8BE24aA04Bb95C5038F8dc1dAE28c0BD191cC36

üí∞ REVENUE SHARE CONTRACTS:
  üè≠ Factory Proxy: 0x60CD9B009799636f59367E4C06b5Ad95Ce1E218F
  üîß Factory Implementation: 0x3cBA4cc0212450144A5C13778B11d8F210d634E2
  üìú RevenueShare Implementation: 0x4151C8c01Eec4426179231AAfB37dCa81Ed19C14
```

## üîÑ Realizando Upgrades

### Upgrade Completo (Todos los Contratos)

```bash
# Red local
npx hardhat run scripts/upgrade-all-contracts.js

# Testnet (Base Sepolia)
npx hardhat run scripts/upgrade-all-contracts.js --network baseSepolia
```

Este script actualiza:

- ‚úÖ **MusicNFTFactoryUpgradeable** (proxy permanece igual)
- ‚úÖ **RevenueShareFactoryUpgradeable** (proxy permanece igual)
- ‚úÖ **Implementations** (direcciones pueden cambiar)

### Upgrade Selectivo

```bash
# Solo actualizar implementations (recomendado)
npx hardhat run scripts/upgrade-all-contracts.js --network baseSepolia --implementations-only

# Actualizar todo incluyendo factories
npx hardhat run scripts/upgrade-all-contracts.js --network baseSepolia --full-upgrade
```

## üéØ Uso de los Contratos

### Frontend: Crear una Nueva Colecci√≥n

```javascript
// Usar la direcci√≥n del factory proxy (nunca cambia)
const factory = await ethers.getContractAt(
  "MusicNFTFactoryUpgradeable",
  "0xAD6474aB644B97A4B82C2128921c32aF69392B15" // Base Sepolia
);

const tx = await factory.createCollection(
  "Mi √Ålbum 2024",                          // name
  "ALBUM24",                                // symbol
  "https://api.midominio.com/metadata/",    // baseURI
  "Metadatos del √°lbum completo",           // collection metadata
  Math.floor(Date.now() / 1000),           // Start date (ahora)
  Math.floor(Date.now() / 1000) + 86400*30, // End date (30 d√≠as)
  "0x0000000000000000000000000000000000000000", // ETH nativo
  "0xArtistAddress...",                     // royalty receiver
  1000,                                     // 10% royalty (1000/10000)
  "0xArtistAddress...",                     // collection owner
  "0xRevenueShareAddress..."                // revenue share contract
);

// Obtener la direcci√≥n de la nueva colecci√≥n del evento
const receipt = await tx.wait();
const event = receipt.logs.find(log => /* buscar CollectionCreated */);
const collectionAddress = event.args.collection;
```

### Frontend: Configurar Revenue Share

```javascript
// Crear revenue share para el artista
const revenueFactory = await ethers.getContractAt(
  "RevenueShareFactoryUpgradeable",
  "0x60CD9B009799636f59367E4C06b5Ad95Ce1E218F" // Base Sepolia
);

const tx = await revenueFactory.createRevenueShare(
  "0xArtistAddress...",     // artist (owner)
  "Revenue Share Album 2024", // name
  "Distribuci√≥n de ingresos para el √°lbum 2024" // description
);

const receipt = await tx.wait();
const revenueShareAddress = /* extraer del evento */;
```

### Interactuar con una Colecci√≥n (Cualquier Plataforma)

```javascript
// Los artistas pueden usar esto en su propia web
const collection = await ethers.getContractAt(
  "MusicCollectionUpgradeable",
  collectionAddress // Direcci√≥n obtenida del factory
);

// Mint con ETH (funciona desde cualquier plataforma)
await collection.mint(
  "0xBuyerAddress...", // to
  1, // tokenId
  5, // cantidad
  ethers.parseEther("0.1"), // precio por token
  "https://metadata.uri", // token metadata
  { value: ethers.parseEther("0.5") } // 5 tokens √ó 0.1 ETH
);

// Mint con ERC20
await collection.mintWithERC20(
  "0xBuyerAddress...", // to
  1, // tokenId
  5, // cantidad
  ethers.parseUnits("50", 6), // precio en USDC (6 decimales)
  "0xUSDCAddress...", // token address
  "https://metadata.uri" // token metadata
);
```

## üåê Portabilidad para Artistas

### Uso Multi-Plataforma

Una vez que un artista crea su colecci√≥n, puede usarla en **cualquier lugar**:

#### **1. En su propia p√°gina web:**

```javascript
// Ejemplo: www.artista.com
const artistCollection = new ethers.Contract(
  "0x123...abc", // Su direcci√≥n de colecci√≥n
  MusicCollectionABI,
  signer
);

// Mint directo desde su web
await artistCollection.mint(...);
```

#### **2. En otros marketplaces:**

- **OpenSea**: Autom√°ticamente detecta ERC1155 + royalties (ERC2981)
- **Rarible**: Soporte completo para colecciones custom
- **Foundation**: Integraci√≥n directa

#### **3. En otras plataformas musicales:**

```javascript
// Ejemplo: Async Art, Catalog, Sound.xyz
const collection = new ethers.Contract(artistCollectionAddress, ABI, signer);
// Funciona autom√°ticamente con revenue splits
```

### Revenue Sharing Universal

Los splits funcionan **autom√°ticamente** sin importar d√≥nde se venda:

```javascript
// Desde cualquier plataforma
const revenueShare = new ethers.Contract(revenueShareAddress, ABI, signer);

// Ver configuraci√≥n actual
const splits = await revenueShare.getMintSplits(collectionAddress, tokenId);

// Los pagos se distribuyen autom√°ticamente en cada mint/venta
```

## ‚ö†Ô∏è Consideraciones de Seguridad

### 1. Autorizaci√≥n de Upgrades

Solo el **owner** puede autorizar upgrades gracias a la funci√≥n `_authorizeUpgrade()`:

```solidity
function _authorizeUpgrade(address newImplementation) internal override onlyOwner {}
```

### 2. Storage Layout (CR√çTICO)

**NUNCA** modifiques el orden de las variables de estado existentes:

```solidity
// ‚úÖ CORRECTO - Agregar nuevas variables al final
contract MusicCollectionUpgradeableV2 {
    // ... todas las variables existentes en el mismo orden ...

    // Nuevas variables al final
    mapping(uint256 => bool) public newFeature;
    uint256 public newCounter;
}

// ‚ùå INCORRECTO - Cambiar orden o insertar en el medio
contract MusicCollectionUpgradeableV2 {
    uint256 public newVariable; // ‚ùå Insertado al inicio
    string public name;         // ‚ùå Esto romper√≠a el storage
    // ... resto de variables
}
```

### 3. Inicializaci√≥n

Usa **siempre** `initialize()` en lugar de constructores:

```solidity
function initialize(
    string memory _name,
    // ... otros par√°metros
) public initializer {
    __ERC1155_init(_baseURI);
    __ERC1155Supply_init();
    __ERC2981_init();
    __Ownable_init(initialOwner);
    __ReentrancyGuard_init();
    __UUPSUpgradeable_init();

    // Inicializaci√≥n custom
    name = _name;
    // ...
}
```

## üîç Verificaci√≥n y Monitoreo

### Verificar Versiones Actuales

```javascript
// Verificar versi√≥n del MusicNFTFactory
const factory = await ethers.getContractAt(
  "MusicNFTFactoryUpgradeable",
  "0xAD6474aB644B97A4B82C2128921c32aF69392B15"
);

const version = await factory.version();
console.log("Factory version:", version);

// Verificar versi√≥n del RevenueShareFactory
const revenueFactory = await ethers.getContractAt(
  "RevenueShareFactoryUpgradeable",
  "0x60CD9B009799636f59367E4C06b5Ad95Ce1E218F"
);

const revenueVersion = await revenueFactory.version();
console.log("Revenue factory version:", revenueVersion);
```

### Verificar Direcciones de Implementation

```javascript
const { upgrades } = require("hardhat");

// Direcci√≥n de implementaci√≥n actual del factory
const factoryImpl = await upgrades.erc1967.getImplementationAddress(
  "0xAD6474aB644B97A4B82C2128921c32aF69392B15"
);

// Direcci√≥n de implementaci√≥n de colecciones
const collectionImpl = await factory.collectionImplementation();

// Direcci√≥n de implementaci√≥n de revenue shares
const revenueImpl = await revenueFactory.revenueShareImplementation();

console.log({
  factoryImpl,
  collectionImpl,
  revenueImpl,
});
```

## üìä Comparaci√≥n: Original vs Upgradeable

| Aspecto            | Contratos Originales   | Contratos Upgradeables       |
| ------------------ | ---------------------- | ---------------------------- |
| **Flexibilidad**   | ‚ùå Sin upgrades        | ‚úÖ Upgrades sin perder datos |
| **Direcciones**    | ‚ùå Cambian en redeploy | ‚úÖ Permanentes               |
| **Gas Deployment** | ‚úÖ Menor inicial       | ‚ö†Ô∏è Ligeramente mayor         |
| **Gas Uso**        | ‚úÖ Directo             | ‚ö†Ô∏è Proxy overhead m√≠nimo     |
| **Compatibilidad** | ‚úÖ Est√°ndar            | ‚úÖ Est√°ndar + upgradeable    |
| **Portabilidad**   | ‚úÖ Total               | ‚úÖ Total + mejor             |
| **Mantenimiento**  | ‚ùå Redeploy completo   | ‚úÖ Upgrade seamless          |

## üöÄ Roadmap de Upgrades

### Versi√≥n Actual (v1.0.0)

- ‚úÖ Arquitectura upgradeable completa
- ‚úÖ Factory + Proxy pattern
- ‚úÖ Revenue sharing autom√°tico
- ‚úÖ Portabilidad total

### Pr√≥ximas Versiones

**v1.1.0 (Pr√≥ximo)**

- üîú Optimizaciones de gas
- üîú Funciones adicionales de metadata
- üîú Mejoras en revenue sharing

**v1.2.0**

- üîú Integraci√≥n con streaming
- üîú Funciones avanzadas de remix
- üîú Multi-chain support

## üîó Enlaces √ötiles

- **OpenZeppelin Upgrades Docs**: https://docs.openzeppelin.com/upgrades-plugins/
- **UUPS Standard**: https://eips.ethereum.org/EIPS/eip-1822
- **Base Sepolia Explorer**: https://sepolia.basescan.org/

## üìû Soporte

Para consultas sobre upgrades:

1. **Revisar documentaci√≥n** de OpenZeppelin Upgrades
2. **Verificar storage layout** antes de cualquier upgrade
3. **Testear en red local** antes de producci√≥n
4. **Consultar con el equipo** para upgrades complejos

---

**La arquitectura upgradeable de Tuneport permite evoluci√≥n continua manteniendo la soberan√≠a de los artistas** üéµüöÄ
